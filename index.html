<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Document</title>
	<script 
		src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js">
	</script>
	<script src="./js/three.js"></script>
	<!--<script src="./js/ColladaLoader.js"></script>-->
	<script src="./js/CombinedCamera.js"></script>
	<script src="./js/Animation.js"></script>
	<script src="./js/AnimationHandler.js"></script>
	<script src="./js/KeyFrameAnimation.js"></script>	

	<script src="./js/Projector.js"></script>
	<!--<script src="./js/CanvasRenderer.js"></script>-->

</head>
<body>
	<div id="theDiv"></div>
	<script>
		var camera, renderer, loader, container;
		var mixer;
		var clock = new THREE.Clock();
		var mouseX = 0, mouseY = 0;
		var windowHalfX = window.innerWidth / 2;
		var windowHalfY = window.innerHeight / 2;

		document.addEventListener( 'mousemove', onDocumentMouseMove, false );
		init();
		animate();

		function init() {

			//init dom container
			container = document.createElement( 'div' );
			document.body.appendChild( container );

			//init renderer
			renderer = new THREE.WebGLRenderer({ antialias: true });
			renderer.setClearColor(0xdddddd);
			renderer.setPixelRatio(window.devicePixelRatio);
			renderer.setSize(window.innerWidth, window.innerHeight);

			container.appendChild( renderer.domElement );
			// $('#theDiv').add(renderer.domElement);
			
			//init scene
			scene = new THREE.Scene();

			//init camera
			camera = new THREE.CombinedCamera(window.innerWidth, window.innerHeight, 1, 1, 1000, 1, 5000);

			camera.position.x = -5;
			camera.position.y = 5;
			camera.position.z = -10;

			camera.toOrthographic();
			camera.setZoom(1);

			//init grid
			var size = 10;
			var divisions = 10;

			var gridHelper = new THREE.GridHelper( size, divisions );
			scene.add( gridHelper );
			
			loader = new THREE.JSONLoader();
			loader.load('./models/THE-NEW-TKPD.json', function(obj, mats){
				// obj.computeVertexNormals();
				// obj.computeTangents();
				// obj.mergeVertices();
				mats.forEach(function(mat){
					mat.skinning = true;
					mat.morphTargets = true;
				});

				var owlMats = new THREE.MultiMaterial( mats );
				var owlMesh = new THREE.SkinnedMesh(obj, owlMats);

				owlMesh.scale.set(1,1,1); 
				
				owlMesh.rotation.z = (180 * Math.PI) / 180;
				owlMesh.rotation.x = (180 * Math.PI) / 180;
				// owlMesh.rotation.y = (180 * Math.PI) / 180;

				scene.add(owlMesh);
				mixer = new THREE.AnimationMixer( owlMesh );
				var clip = THREE.AnimationClip.CreateFromMorphTargetSequence('nganga', obj.morphTargets, 30);
				// mixer.clipAction(obj.animations[2]).play();
				// mixer.clipAction(obj.animations[5]).play();
				mixer.clipAction(clip).play();

			});

			// loader.load('./models/animated-cube.json', function(geometry, materials) {

			// 	materials.forEach(function(material){
			// 		material.skinning = true;
			// 		// material.morphTargets = true;
			// 	});

			// var cubeMats = new THREE.MultiMaterial(materials);
			// var cube = new THREE.SkinnedMesh(geometry, cubeMats);
			// // var cube = new THREE.Mesh(geometry, cubeMats);
			// scene.add(cube);
			// mixer = new THREE.AnimationMixer( cube );
			// // var clip = THREE.AnimationClip.CreateFromMorphTargetSequence( 'test', geometry.morphTargets, 30 );
			// mixer.clipAction(geometry.animations[0]).play();
					

			// });

			//init lights
			var ambientLight = new THREE.AmbientLight(0xffffff, 1.2);
			scene.add( ambientLight );

			var pointLight = new THREE.PointLight(0xffffff, 1);
			pointLight.position.y = 5;
			scene.add(pointLight);

		}

		function onDocumentMouseMove(event) {
			mouseX = ( event.clientX - windowHalfX);
			mouseY = ( event.clientY - windowHalfY );
		}

		function animate() {
			requestAnimationFrame(animate);
			render();
		}

		function render() {			
			var delta = 0.75 * clock.getDelta();
			mixer.update( delta );

			// camera.position.x -= .05;
			camera.position.x += ( mouseX - camera.position.x ) * .001;
			// camera.position.y = THREE.Math.clamp( camera.position.y + ( - mouseY - camera.position.y ) * .05, 0, 1000 );
			camera.lookAt(scene.position);

			renderer.render( scene, camera );
		}


	</script>
</body>
</html>